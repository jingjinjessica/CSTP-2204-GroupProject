<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head'); -%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js" integrity="sha512-ew6biq+ZLL9Oatatxp3TMwzqfYWjPNVj555KxiE2mV5Sc2/1Z5SOWSbViBH+KXU788ESsXDa5m0cgRKTBqO44w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
 
<body>
        <%- include('../partials/header'); -%>
            <section class="section owner-info">
                <div class="container">
                    <div class="row align-items-center columnEdit ">
                        <div class="col-lg-5">
                            <div class="info-avatar">
                                <img id="userImg" src="<%= owner.petImage %>" class="info-img" alt="user-image"  name="avatar">
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="about-text go-to">
                                <div class="row info-list">
                                    <div class="col-md-12">
                                        <div class="info-area">
                                            <div class="media username">
                                                <span type="text" id="username" value="<%= post.title %>">
                                                    <%= post.title %>
                                                </span>
                                                
                                            </div>
                                            <div class="media">
                                                <label class="petname">Pet Name:</label>
                                                <span id="username" name="name" class="introduction"><%= owner.petName%></span>
                                            </div>
                                            <div class="media">
                                                <label class="petname">Pet Owner:</label>
                                                <span id="username" name="name" class="introduction"><%= owner.name%></span>
                                            </div>
                                            <div class="media">
                                                <label class="petname">Location:</label>
                                                <span class="location" name="province" class="introduction" ><%= owner.city%>, <%= owner.province%></span>
                                            </div>
                                            <!-- <div class="media">
                                                <label class="petname">City:</label>
                                                <span class="location" name="city" class="introduction"></span>
                                            </div> -->
                                            <div class="media">
                                                <label class="petname">Type:</lable>
                                                    <span class="location">
                                                        <%= owner.petType %>
                                                        
                                                    </span>
                                            </div>
                                            <div class="media">
                                                <label class="petname">Age:</lable>
                                                    <span class="location">
                                                        <%= owner.petAge %>
                                                    </span>
                                            </div>
                                            <div class="media">
                                                <label class="petname">Weight:</label>
                                                <span class="location">
                                                    <%= owner.petWeight %>
                                                </span>
                                            </div>
                                            <div class="media requirement-area">
                                                <span class="requirement-title">Requirement:</span>
                                                <p class="requirement text-break" id="requirement" value="<%= post.desc %>">
                                                    <%= post.desc %>
                                                </p>
                                            </div>

                                            <div class="media">
                                                <label class="petname">Start Date:</label>
                                                <span class="location">
                                                    <%= post.startDate %>
                                                </span>
                                            </div>
                                            <div class="media">
                                                <label class="petname">End Date:</label>
                                                <span class="location">
                                                    <%= post.endDate %>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

             <section class="section pet-info">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-lg-5">
                            <div class="about-avatar">
                                <img id="petImg" src="/image/dog-cat-under-sheet.jpg" class="info-img" alt="pet-img">
                            </div>
                        </div>    
                        <div class="col-lg-6">    
                            <div class="info-text go-to">
                                <div class="row info-list">
                                    <div class="col-md-12">
                                        <div class="intro-area">
                                            <div class="media">
                                                <span class="petname" id="petname">Pet Name</span>
                                            </div>
                                            <div class="media intro-area">
                                                <span class="intro-title">Introduction:</span>
                                                <p class="introduction" id="introduction">Lorem ipsum dolor sit amet,
                                                    consectetur adipiscing elit, sed do eiusmod
                                                    tempor incididunt ut labore et dolore magna aliqua.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                       </div>                        
                    </div>
                </div>
            </section> 


            <!-- LIVE CHAT -->

             <div id="chatBox">
                <header class="clearfix">
                   
                   <h4><span aria-hidden="true" class="icon-bubble"></span> Message to <%=owner.name%></h4>
                   
                </header>

                <div class="chat" style="display: none;">
                    <div id="chatContainer">
                        <div id="friendslist">
                            <form id="search">
                                <input type="text" id="searchfield" placeholder="Enter your message..." />
                                <button type="submit">Send</button>
                            </form> 
                            <!-- <div id="friends">
                                <div class="friend">
                                    <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/1_copy.jpg" />
                                    <p>
                                        <strong>Miro Badev</strong>
                                    </p>
                                    <div class="status available"></div>
                                </div>
        
                                <div id="search">
                                    <input type="text" id="searchfield" value="Search contacts..." />
                                </div> 
        
                            </div>                
        
                        </div>	
        
                            <div id="chatview" class="p1">   
                                <!--FRIEND EXAMPLE -->
                                 <!-- <div id="profileInfo">
            
                                    <div id="close">
                                        <div class="cy"></div>
                                        <div class="cx"></div>
                                    </div>
                                    <p>Miro Badev</p>
                                </div>

                                <div id="chat-content">

                                    <!-- You can use this id or manually create it from server -->
                                     <!-- <div id="Ownermessage"></div>
                                    <div id="Sittermessage"></div>
                                </div>
        
                                <div id="sendmessage">
                                    <input type="text" value="Send message..." />
                                    <button id="send">Send</button>
                                </div> --> 
        
                            </div>     
                     </div>	
                        <!-- end live-chat -->
          
                 </div> 
          
            </div> 


             <!-- <div class="live-chat-area">
                <h4 class="live-chat-title">Live Chat</h4>
                <a><i class="material-symbols-outlined live-chat">sms</i></a>
            </div> 
             <div class="floating-container">
                <div class="floating-button">
                    <h4 class="live-chat-title">Live Chat</h4>
                    <img src="https://img.icons8.com/ios/50/00000/chat-message--v1.png" class="live-chat" alt="live-chat" onclick="openLiveChat()" />
                    
                    <a><i class="material-symbols-outlined live-chat">--sms--</i></a></div>
            </div>  -->
            <%- include('../partials/footer') %>
            <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
            <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
            <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
            <script src="/js/chat.js"></script> 
    </body>

</html>
<script>

document.getElementById("search").addEventListener("submit", postChat);
async function postChat(e) {
  e.preventDefault();

    const ownerId = `<%- owner.userID %>`;
    const ownerName = `<%- owner.name %>`;
    const ownerAvatar = `<%- owner.avatar %>`;

    // console.log(ownerId, ownerName, ownerAvatar);

  try {
    const response = await fetch("/profile/getCurrUserProfile", {
      method: "get",
      headers: {
        "Content-type": "application/json",
        Authorization: `Bearer ${JSON.parse(
          localStorage.getItem("access-token")
        )}`,
      },
    })

    const currUserProfile = await response.json();
    // console.log("from api",currUserProfile);
    
    const currUserId = currUserProfile.profile.userID;
    const currUserName = currUserProfile.profile.name;
    const currUserAvatar = currUserProfile.profile.avatar;
    
    const roomId = ownerId + "_" + currUserId;


    if(currUserProfile){
        localStorage.setItem("profile",JSON.stringify(currUserProfile.profile));
    }

    const msg = document.getElementById("searchfield").value;

    
    await sendMsg(roomId, currUserName, ownerName,currUserAvatar,ownerAvatar, msg);

    const msgDisplay = document.createElement("div");
    msgDisplay.innerHTML = "<p><strong>"+currUserName+":</strong> " + msg + "</p>";
    const msgList = document.getElementById("chatContainer");
    msgList.appendChild(msgDisplay);

  } 
  catch (error) {
    console.log(error);
  }
};

    (function() {
 
    $('#chatBox header').on('click', function() {
 
       $('.chat').slideToggle(300, 'swing');

 
    });
    }) ();
 
    $(document).ready(function(){
 
        // var preloadbg = document.createElement("img");
        // preloadbg.src = "https://s3-us-west-2.amazonaws.com/s.cdpn.io/245657/timeline1.png";
    
        // $("#searchfield").focus(function(){
        // if($(this).val() == "Search contacts..."){
        //     $(this).val("");
        // }
        // });
        // $("#searchfield").focusout(function(){
        // if($(this).val() == ""){
        //     $(this).val("Search contacts...");
            
        // }
        // });
    
        $("#sendmessage input").focus(function(){
        if($(this).val() == "Send message..."){
            $(this).val("");
        }
        });
        $("#sendmessage input").focusout(function(){
        if($(this).val() == ""){
            $(this).val("Send message...");
            
        }
        });
       
 
        $(".friend").each(function(){		
        $(this).click(function(){
            var childOffset = $(this).offset();
            var parentOffset = $(this).parent().parent().offset();
            var childTop = childOffset.top - parentOffset.top;
            var clone = $(this).find('img').eq(0).clone();
            var top = childTop+17+"px";
            
            $(clone).css({'top': top}).addClass("floatingImg").appendTo("#chatContainer");									
            
            setTimeout(function(){$("#profileInfo p").addClass("animate");$("#profileInfo").addClass("animate");}, 100);
            setTimeout(function(){
                $("#chat-content").addClass("animate");
                $('.cx, .cy').addClass('s1');
                setTimeout(function(){$('.cx, .cy').addClass('s2');}, 100);
                setTimeout(function(){$('.cx, .cy').addClass('s3');}, 200);			
            }, 150);														
            
            $('.floatingImg').animate({
                'width': "50px",
                'left':'15px',
                'top':'20px'
            }, 200);
            
            var name = $(this).find("p strong").html();
            var email = $(this).find("p span").html();														
            $("#profileInfo p").html(name);
            $("#profileInfo span").html(email);			
            
            $(".message").not(".right").find("img").attr("src", $(clone).attr("src"));									
            $('#friendslist').fadeOut();
            $('#chatview').fadeIn();
        
            
            $('#close').unbind("click").click(function(){				
                $("#chat-content, #profileInfo, #profileInfo p").removeClass("animate");
                $('.cx, .cy').removeClass("s1 s2 s3");
                $('.floatingImg').animate({
                    'width': "50px",
                    'top':top,
                    'left': '15px'
                }, 200, function(){$('.floatingImg').remove()});				
                
                setTimeout(function(){
                    $('#chatview').fadeOut();
                    $('#friendslist').fadeIn();				
                }, 50);
            });   
        });
    });			
});
</script>